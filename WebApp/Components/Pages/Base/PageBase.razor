@namespace WebApp.Components.Pages.Base
@using MeCab
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using System.Diagnostics
@using WebApp.Components.Providers
@using WebApp.Models

@inject NavigationManager Navigation

@code{
    #region セッション管理
    /// <summary>
    /// セッション定数；遷移前URL
    /// </summary>
    private const string SessionBeforeNavigateTo ="SessionBeforeNavigateTo";

    /// <summary>
    /// セッション管理プロバイダークラス
    /// </summary>
    [CascadingParameter]
    private SessionStorageProvider? sessionStorageProvider { get; set; }

    /// <summary>
    /// ログイン前か否か
    /// </summary>
    protected bool IsBeforeLoginCheck  { get; set; } = true;

    /// <summary>
    /// セッションの取得
    /// </summary>
    /// <param name="name">キー名</param>
    /// <typeparam name="T">変換型</typeparam>
    /// <returns>変換型に変換した値</returns>
    protected async Task<T?> GetAsync<T>(string name)
    {
        if(sessionStorageProvider is not null){
            var result = await sessionStorageProvider.GetAsync<T>(name);
            if(result.Success) return result.Value;
        }
        return default(T);
    }

    /// <summary>
    /// セッションの設定
    /// </summary>
    /// <param name="name">キー名</param>
    /// <param name="value">値</param>
    /// <typeparam name="T">変換型</typeparam>
    protected async Task SetAsync<T>(string name, T value)
    {
        if (sessionStorageProvider is not null)
        {
            await sessionStorageProvider.SetAsync<T>(name, value);
        }
    }

    /// <summary>
    /// セッションの削除
    /// </summary>
    /// <param name="name">キー名</param>
    protected async Task DeleteAsync(string name)
    {
        if (sessionStorageProvider is not null)
        {
            await sessionStorageProvider.DeleteAsync(name);
        }
    }

    /// <summary>
    /// セッションクリア
    /// </summary>
    protected async Task Clear()
    {
        if (sessionStorageProvider is not null)
        {
            await sessionStorageProvider.Clear();
        }
    }

    /// <summary>
    /// ログインチェック
    /// </summary>
    /// <returns>ログイン済みか否か</returns>
    protected async Task<bool> LoginCheck()
    {
        var loggedIn = await GetAsync<bool>(UserModel.SessionLoggedIn);
        if (!loggedIn) Navigation.NavigateTo("/login");
        return loggedIn;
    }

    /// <summary>
    /// ユーザーマスタ取得
    /// </summary>
    /// <returns>ユーザーマスタ</returns>
    protected async Task<UserModel?> GetUserAsync()
    {
        var userMasterString = await GetAsync<string>(UserModel.SessionUser);
        if(userMasterString is not null)
        {
            return userMasterString!.Deserialize<UserModel>();
        }
        return null;
    }
    #endregion

    #region ログ出力
    /// <summary>
    /// ログメッセージ文字列取得
    /// </summary>
    /// <param name="message">独自メッセージ</param>
    /// <param name="memberName">呼び出しメソッド名</param>
    /// <returns>ログメッセージ文字列</returns>
    protected async Task<string> GetLogMessage(string message, [System.Runtime.CompilerServices.CallerMemberName] string memberName = "")
    {
        var userData = string.Empty;
        var userModel = await GetUserAsync();
        if(userModel is not null)
        {
            userData = $"{userModel.ID} {userModel.Fullname} ";
        }

        return $"{userData}{message} url={Navigation.Uri} method={memberName} requestID={Activity.Current?.Id}";
    }

    /// <summary>
    /// エラーログメッセージ文字列取得
    /// </summary>
    /// <param name="exception">例外インスタンス</param>
    /// <param name="memberName">呼び出しメソッド名</param>
    /// <returns>ログメッセージ文字列</returns>
    protected async Task<string> GetLogError(Exception exception, [System.Runtime.CompilerServices.CallerMemberName] string memberName = "")
    {
        var userData = string.Empty;
        var userModel = await GetUserAsync();
        if(userModel is not null)
        {
            userData = $"{userModel.ID} {userModel.Fullname} ";
        }

        return $"Error {userData}Message[{exception.Message}] StackTrace[{exception.StackTrace}] url={Navigation.Uri} method={memberName} requestID={Activity.Current?.Id}";
    }
    #endregion

    #region 画面遷移
    /// <summary>
    /// 例外時エラーページに遷移する
    /// </summary>
    protected void GotoErrorPage()
    {
        Navigation.NavigateTo("/error");
    }

    /// <summary>
    /// 指定ページに遷移する
    /// </summary>
    /// <param name="url">対象ページのURL</param>
    protected async Task GotoPageAsync(string url)
    {
        // 現在のURLをセッションに格納する
        await SetAsync(SessionBeforeNavigateTo, Navigation.Uri);

        // 画面遷移
        Navigation.NavigateTo(url);
    }

    /// <summary>
    /// セッションに格納したURLに遷移する
    /// </summary>
    protected async Task PageBackAsync()
    {
        // 現在のURLをセッションから取得
        var url = await GetAsync<string>(SessionBeforeNavigateTo);

        // セッション削除
        await DeleteAsync(SessionBeforeNavigateTo);

        // 画面遷移
        Navigation.NavigateTo(url!);
    }
    #endregion

    #region ダイアログ表示
    /// <summary>
    /// ダイアログプロバイダークラス
    /// </summary>
    [CascadingParameter]
    private DialogProvider? dialogProvider {get; set; }

    /// <summary>
    /// アラートメッセージ表示
    /// </summary>
    /// <param name="message">メッセージ本文</param>
    /// <param name="submitFunction">「OK」クリック時のコールバックメソッド</param>
    protected async Task ShowAlert(string message, Func<Task>? submitFunction = null)
    {
        if(dialogProvider is null)  return;

        await dialogProvider.ShowAlert(message, submitFunction);
    }

    /// <summary>
    /// 確認メッセージ表示
    /// </summary>
    /// <param name="message">メッセージ本文</param>
    /// <param name="submitFunction">「はい」クリック時のコールバックメソッド</param>
    public async Task ShowConfirm(string message, Func<Task> submitFunction)
    {
        if(dialogProvider is null)  return;

        await dialogProvider.ShowConfirm(message, submitFunction);
    }
    #endregion

    #region 漢字→フリガナ変換
    /// <summary>
    /// 漢字→フリガナ変換
    /// </summary>
    /// <param name="kanjiValue">漢字文字列</param>
    /// <returns>フリガナ文字列(kanjiValueがnullの場合はstring.Empty)</returns>
    protected string ToKatakana(string? kanjiValue)
    {
        // kanjiValueがnullの場合は空文字
        if(kanjiValue is null) return string.Empty;

        var result = new System.Text.StringBuilder();

        // 字句解析インスタンスを生成
        var parameter = new MeCabParam();
        var tagger = MeCabTagger.Create(parameter);

        // 漢字をフリガナ変換
        foreach (var node in tagger.ParseToNodes(kanjiValue))
        {
            if (node.CharType > 0)
            {
                var features = node.Feature.Split(',');
                if (features.Length > 8)
                {
                    // 単語単位で変換結果を格納
                    var yomiKatakana = features[7];
                    result.Append($"{yomiKatakana}");
                }
                else
                {
                    // 半角英数字の場合はそのまま出力
                    result.Append(node.Surface);
                }
            }
        }
        return result.ToString();
    }
    #endregion
}
